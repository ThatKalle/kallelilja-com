name: 'üõ°Ô∏è CodeQL'

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    - cron: '17 22 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: 'ubuntu-latest'
    permissions:
      actions: read
      contents: read
      packages: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Setup Hugo
      if: matrix.language == 'javascript-typescript'
      id: setup_hugo
      uses: peaceiris/actions-hugo@75d2e84710de30f6ff7268e08f310b60ef14033f # v3.0.0
      with:
        hugo-version: '0.145.0'
        extended: true

    - name: Cache Hugo modules
      if: steps.setup_hugo.outcome == 'success'
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: ${{ runner.temp }}/hugo_cache
        key: hugomod-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
        restore-keys: hugomod-${{ runner.os }}-

    - name: Initialize CodeQL
      uses: github/codeql-action/init@1b549b9259bda1cb5ddde3b41741a82a2d15a841 # v3.28.13
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        config-file: '.github/codeql-config.yml'
    
    - name: Build with Hugo
      if: matrix.language == 'javascript-typescript'
      run: |
        hugo \
          --gc \
          --minify \
          --enableGitInfo \
          --baseURL "${URL}"
      shell: bash
      working-directory: web
      env:
        HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
        HUGO_ENVIRONMENT: production
        TZ: Europe/Stockholm
        URL: "https://kallelilja.com"
        HUGO_PARAMS_gitCommit: 'codeql'

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@1b549b9259bda1cb5ddde3b41741a82a2d15a841 # v3.28.13
      with:
        category: "/language:${{ matrix.language }}"
        output: sarif-results
        upload: failure-only

    - name: filter-sarif - javascript-typescript
      if: matrix.language == 'javascript-typescript'
      uses: advanced-security/filter-sarif@f3b8118a9349d88f7b1c0c488476411145b6270d #  v1.0.1
      with:
        patterns: |
          -**/*.js:js/regex/missing-regexp-anchor
        input: "sarif-results/javascript.sarif"
        output: "sarif-results/${{ matrix.language }}.sarif"

    - name: Upload CodeQL sarif
      uses: github/codeql-action/upload-sarif@1b549b9259bda1cb5ddde3b41741a82a2d15a841 # v3.28.13
      with:
        sarif_file: "sarif-results/${{ matrix.language }}.sarif"
